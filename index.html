<html><head>
<title>Look at some Hershey Fonts!</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script type="module">
/**
 * Copyright 2011 Marty McGuire
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import Hershey from './js/hershey.js';

let my_font;
let exportable;

let max_w = 266; // (75mm / 0.28222mm/px), Inkscape's mm-per-px magic number.
let max_h = 266;
max_w = max_w - 10; // gutters
max_h = max_h - 10; // gutters

// quick and dirty helper for making SVG elements
const svg = {
  group: function(parentElem, attrs) {
    return this.createElement('g', parentElem, attrs);
  },

  path: function(parentElem, attrs) {
    return this.createElement('path', parentElem, attrs);
  },

  createElement: function(name, parentElem, attrs) {
    const ns = "http://www.w3.org/2000/svg"
    const el = document.createElementNS(ns, name);
    for (const attr in attrs) {
      el.setAttribute(attr, attrs[attr]);
    }
    parentElem.appendChild(el);
    return el;
  }
}

function displayText(grp,text,x,y){
  const paths = my_font.pathsForText(text);
  const tg = svg.group(grp, {'transform': 'translate(' + x + ',' + y + ')'});
  paths.forEach(function(path){
    //var yoff = Math.floor((i/25)+1)*40;
    if(path.d != []){
      const attrs = { d: path.d };
      if(path.translate !== undefined) {
        attrs['transform'] = 'translate(' + path.translate[0] + ',' + path.translate[1] + ')';
      }
      svg.path(tg, attrs);
    }
  });
}

function displayTextboxContent(){
  const scale = 1.0;
  const line_height = 35;

  // First, split long lines.
  const lines = textarea.value.split('\n');
  const wrapped_lines = wrapLines(lines, max_w, max_h, scale);

  const textgrp = document.querySelector('#hershey_text');
  textgrp.innerHTML = '';
  textgrp.setAttribute('transform','scale(' + wrapped_lines.scale + ')');
  for(var i = 0; i < wrapped_lines.lines.length; i++){
    displayText(textgrp, wrapped_lines.lines[i], 5, (line_height / 2) + (line_height * i));
  }

  /*
  const scribgrp = document.querySelector('#scribbles');
  if((scribblePaths != undefined) && (scribblePaths != [])){
    scribblePaths.forEach(function(path){
      svg.path(scribgrp, path);
    });
  }
  */

  updateExport();
}

function updateExport() {
  exportable = document.querySelector('#exportable');
  let str = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="'
            + max_w + '" height="' + max_h + '">';
  str += exportable.outerHTML;
  str += '</svg>';
  svgout.value = str;
}

function wrapLines(lines, max_w, max_h, scale){
  // TODO: split on last char if unbroken by whitespace.
  var wrapped_lines = [];
  var done = false;
  var line_height = 35;
  while(!done){
    var scaled_h = max_h / scale;
    var scaled_w = max_w / scale;
    for(var i = 0; i < lines.length; i++){
      var line = lines[i];
      var newline = "";
      var line_w = 0;
      var sep = "";
      var words = line.split(' '); // TODO: on any whitespace
      for(var j = 0; j < words.length; j++){
        var word = words[j];
        var w = my_font.boundsForText(word).w;
        var sep_w = my_font.boundsForText(sep).w;
        var new_w = line_w + sep_w + w;
        if(new_w < scaled_w){
          newline += sep + word;
          line_w += sep_w + w;
          sep = " ";
        } else {
          wrapped_lines.push(newline);
          newline = word;
          line_w = w;
        }
      }
      if(newline != "")
        wrapped_lines.push(newline);
    }
    if(wrapped_lines.length * line_height > scaled_h){
      scale *= 0.9;
      wrapped_lines = [];
    } else {
      done = true;
    }
  }
  return {'lines':wrapped_lines, 'scale':scale};
}

function changeFont(){
  var fontPath = document.querySelector('#fontselector').value;
  my_font.loadFont(fontPath).then(displayTextboxContent);
}

function pathForScribble(scribble){
  var sep = "";
  var segstr = "";
  if(scribble && (scribble.length > 0)){
    var orig = scribble[0];
    segstr += sep + "M " + orig[0] + " " + orig[1];
    var tscrib = scribble.slice(1,scribble.length);
    tscrib.forEach(function(pt){
      segstr += " L " + pt[0] + " " + pt[1];
    });
    sep = " ";
  }
  return segstr;
}

var mouseDown = false;
var scribbles = [];
var thisScribble = [];
var scribblePaths = null;
var cnvs;
var textarea;
var svgout;
var currentPath;

function drawStart(evt) {
  evt.preventDefault();
  mouseDown = true;
  thisScribble = [];
  const scribblesElem = document.querySelector('#scribbles');
  currentPath = svg.path(scribblesElem, { d: "" });
}

function drawEnd(evt){
  evt.preventDefault();
  if(mouseDown && thisScribble != []){
    scribbles.push(thisScribble);
  }
  mouseDown = false;
  currentPath = null;
}

function drawMove(evt){
  evt.preventDefault();
  if(mouseDown){
    // need to transform new point's coordinate into drawing space.
    // (the inverse of the transform displayed over the sticky note)
    // https://stackoverflow.com/a/33579846
    // https://stackoverflow.com/a/64984121
    const svgElem = document.querySelector('#drawing');
    const wrapper = svgElem.children[0];
    // get current transformation matrix
    const matrix = wrapper.getCTM();
    const p = svgElem.createSVGPoint();
    p.x = evt.offsetX;
    p.y = evt.offsetY;
    const newp = p.matrixTransform(matrix.inverse());
    thisScribble.push([newp.x.toFixed(3), newp.y.toFixed(3)]);
    currentPath.setAttribute('d', pathForScribble(thisScribble));
  }
  updateExport();
}

document.addEventListener(
  'DOMContentLoaded',
  function() {
    const fontselector = document.querySelector('#fontselector');
    textarea = document.querySelector('#textula');
    cnvs = document.querySelector('#drawing');
    svgout = document.querySelector('#svg_out');

    my_font = new Hershey();
    my_font.loadFont(fontselector.value)
      .then(displayTextboxContent);

    textarea.addEventListener('keyup', displayTextboxContent);
    fontselector.addEventListener('change', changeFont);

    cnvs.addEventListener('pointerdown', drawStart);
    cnvs.addEventListener('pointerup', drawEnd);
    cnvs.addEventListener('pointermove', drawMove);

  }
);

</script>
</head>
<body>
<svg id="drawing" style="width: 600px; height: 670px; background: url(post-it-note.jpg); float:left; cursor: pointer; touch-action: none">
  <g id="post-it-wrapper" transform="rotate(-3) translate(5,80) scale(2.10)">
    <g id="exportable" stroke="black" fill="none" strokeLinecap="round" strokeLinejoin="round">
      <g id="hershey_text"></g>
      <g id="scribbles"></g>
    </g>
  </g>
</svg>
<textarea id="textula" rows="10" cols="40" style="float:left">
Type! (or draw).
</textarea>
<textarea id="svg_out" rows="20" cols="40" style="float:left">
SVG Data Goes Here.
</textarea>
<select id="fontselector">
<option value="./hershey/astrology.jhf">astrology</option>
<option value="./hershey/cursive.jhf">cursive</option>
<option value="./hershey/cyrilc_1.jhf">cyrilc_1</option>
<option value="./hershey/cyrillic.jhf">cyrillic</option>
<option value="./hershey/futural.jhf">futural</option>
<option value="./hershey/futuram.jhf">futuram</option>
<option value="./hershey/gothgbt.jhf">gothgbt</option>
<option value="./hershey/gothgrt.jhf">gothgrt</option>
<option value="./hershey/gothiceng.jhf">gothiceng</option>
<option value="./hershey/gothicger.jhf">gothicger</option>
<option value="./hershey/gothicita.jhf">gothicita</option>
<option value="./hershey/gothitt.jhf">gothitt</option>
<option value="./hershey/greek.jhf">greek</option>
<option value="./hershey/greekc.jhf">greekc</option>
<option value="./hershey/greeks.jhf">greeks</option>
<option value="./hershey/japanese.jhf">japanese</option>
<option value="./hershey/markers.jhf">markers</option>
<option value="./hershey/mathlow.jhf">mathlow</option>
<option value="./hershey/mathupp.jhf">mathupp</option>
<option value="./hershey/meteorology.jhf">meteorology</option>
<option value="./hershey/music.jhf">music</option>
<option value="./hershey/rowmand.jhf">rowmand</option>
<option value="./hershey/rowmans.jhf">rowmans</option>
<option value="./hershey/rowmant.jhf">rowmant</option>
<option value="./hershey/scriptc.jhf">scriptc</option>
<option value="./hershey/scripts" selected>scripts</option>
<option value="./hershey/symbolic.jhf">symbolic</option>
<option value="./hershey/timesg.jhf">timesg</option>
<option value="./hershey/timesi.jhf">timesi</option>
<option value="./hershey/timesib.jhf">timesib</option>
<option value="./hershey/timesr.jhf">timesr</option>
<option value="./hershey/timesrb.jhf">timesrb</option>
</select>
</body></html>
